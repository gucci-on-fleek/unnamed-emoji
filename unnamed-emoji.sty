
% Preliminaries
\NeedsTeXFormat{LaTeX2e}

\ProvidesExplPackage
    {unnamed-emoji}
    {2023/06/09} %%slashdate
    {v0.0.1} %%version
    {An as-of-yet unnamed emoji package}

% Generate needed variants
\cs_generate_variant:Nn \iow_now:Nn { NV }
\cs_generate_variant:Nn \tl_put_left:Nn { Ne }

% Declare variables
\prop_new:N \g__unemoji_used_prop
\seq_new:N \g__unemoji_used_seq

% pdfTeX
\sys_if_engine_pdftex:T {
    % Loads an emoji
    \cs_new_protected:Nn \__unemoji_load:nn {
        \pdfximage named { emoji #2 } { #1 }
        \prop_put:NnV \g__unemoji_used_prop { #2 } \pdflastximage
    }

    % Prints an emoji
    \cs_new_protected:Nn \__unemoji_print:nn {
        \prop_get:NnNTF \g__unemoji_used_prop { #2 } \l_tmpa_tl {
            \pdfrefximage \l_tmpa_tl \scan_stop:
        }{
            \__unemoji_load:nn { #1 } { #2 }
            \pdfrefximage \pdflastximage \scan_stop:
            \seq_gput_right:Nn \g__unemoji_used_seq { #2 }
        }
    }
}

% LuaTeX
\sys_if_engine_luatex:T {
    \lua_load_module:n { unnamed-emoji }
}

% Bad engine
\cs_if_exist:NF \__unemoji_print:nn {
    \msg_new:nnn
        { unnamed-emoji }
        { bad-engine }
        { LuaTeX~ or~ pdfTeX~ is~ REQUIRED! }

    \msg_critical:nn { unnamed-emoji } { bad-engine }
}

% Public interface
\NewDocumentCommand { \emoji } { O{noto-emoji.pdf} m } {
    \__unemoji_print:nn { #1 } { #2 }
}

% Save the list of used emojis to the aux file
\hook_gput_code:nnn { enddocument / afterlastpage } { unnamed-emoji } {
    \clist_set_from_seq:NN \l_tmpa_clist \g__unemoji_used_seq

    \tl_put_left:Ne \l_tmpa_clist {
        \token_to_str:N \emoji@register \c_left_brace_str
    }

    \tl_put_right:NV \l_tmpa_clist \c_right_brace_str

    \iow_now:NV \@auxout \l_tmpa_clist
}

% Preload the used emojis from the aux file
\cs_new_protected:Nn \__unemoji_register:n {
    \clist_map_inline:nn { #1 } {
        \__unemoji_load:nn { noto-emoji.pdf } { ##1 }
    }
}
\cs_set_eq:NN \emoji@register \__unemoji_register:n

\endinput
